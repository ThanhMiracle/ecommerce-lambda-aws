server {
  listen 80;
  server_name localhost;

  # ----- basic safety / sizing -----
  client_max_body_size 20m;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;

  # Common proxy headers (re-used)
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # If you ever need websocket support, keep these:
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection $connection_upgrade;

  # Map for websocket Connection header (safe even if unused)
  map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
  }

  # -----------------------
  # Frontend (static SPA)
  # -----------------------
  location / {
    proxy_pass http://web:80;
    proxy_http_version 1.1;
  }

  # -----------------------
  # Auth service
  # -----------------------
  # Calls like: /api/auth/login -> auth:8000/login
  location /api/auth/ {
    proxy_pass http://auth:8000/;
    proxy_http_version 1.1;
  }

  # -----------------------
  # Product service
  # -----------------------
  # Calls like: /api/product/admin/products -> product:8000/admin/products
  location /api/product/ {
    proxy_pass http://product:8000/;
    proxy_http_version 1.1;
  }

  # Local image/static serving from product-service
  # Calls like: /static/prod_1_xxx.jpg -> product:8000/static/prod_1_xxx.jpg
  location /static/ {
    proxy_pass http://product:8000/static/;
    proxy_http_version 1.1;

    # Optional caching for images (tweak if you want)
    add_header Cache-Control "public, max-age=86400" always;
  }

  # -----------------------
  # Order service
  # -----------------------
  location /api/order/ {
    proxy_pass http://order:8000/;
    proxy_http_version 1.1;
  }

  # Optional health check
  location /healthz {
    return 200 "ok\n";
  }
}
